rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow read/write access on all documents to any user signed in to the application
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Special rule for feedback collection - allow anonymous feedback with security measures
    match /feedback/{document} {
      allow create: if 
        // Basic validation
        request.resource.data.keys().hasAll(['message', 'userId', 'timestamp']) &&
        request.resource.data.keys().hasOnly(['message', 'userId', 'userEmail', 'timestamp']) &&
        
        // Message validation
        request.resource.data.message is string &&
        request.resource.data.message.size() >= 5 &&
        request.resource.data.message.size() <= 1000 &&
        
        // Timestamp validation (must be recent)
        request.resource.data.timestamp is timestamp &&
        request.resource.data.timestamp > request.time - duration.value(5, 'm') &&
        request.resource.data.timestamp < request.time + duration.value(1, 'm') &&
        
        // UserId validation
        request.resource.data.userId is string &&
        request.resource.data.userId.size() <= 100;
        
      allow read, update, delete: if request.auth != null; // Only authenticated users can read/update/delete
    }
  }
}