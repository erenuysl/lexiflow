rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User data - only allow access to own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // User's daily words subcollection
      match /daily_words/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Other user subcollections (if any)
      match /{subcollection=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Leaderboard stats - allow read for all authenticated users, write only for document owner
    match /leaderboard_stats/{userId} {
      allow read: if request.auth != null;        // All signed-in users can view leaderboard
      allow write: if request.auth.uid == userId; // Only owner can update their stats
    }
    
    // Global collections that all authenticated users can read
    match /categories/{document} {
      allow read: if request.auth != null;
      allow write: if false; // Only admin can write
    }
    
    match /words/{document} {
      allow read: if request.auth != null;
      allow write: if false; // Only admin can write
    }
    
    // Public words collection for daily word selection
    match /public_words/{document} {
      allow read: if request.auth != null;
      allow write: if false; // Only admin can write
    }
    
    // Special rule for feedback collection - allow anonymous feedback with security measures
    match /feedback/{document} {
      allow create: if 
        // Basic validation
        request.resource.data.keys().hasAll(['message', 'userId', 'timestamp']) &&
        request.resource.data.keys().hasOnly(['message', 'userId', 'userEmail', 'timestamp']) &&
        
        // Message validation
        request.resource.data.message is string &&
        request.resource.data.message.size() >= 5 &&
        request.resource.data.message.size() <= 1000 &&
        
        // Timestamp validation (must be recent)
        request.resource.data.timestamp is timestamp &&
        request.resource.data.timestamp > request.time - duration.value(5, 'm') &&
        request.resource.data.timestamp < request.time + duration.value(1, 'm') &&
        
        // UserId validation
        request.resource.data.userId is string &&
        request.resource.data.userId.size() <= 100;
        
      allow read, update, delete: if request.auth != null; // Only authenticated users can read/update/delete
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}